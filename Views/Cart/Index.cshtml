@model List<CartItem>

@{
    ViewData["Title"] = "Giỏ Hàng - KLDShop";
    ViewData["MetaDescription"] = "Xem và quản lý giỏ hàng của bạn tại KLDShop. Cập nhật số lượng, áp dụng mã giảm giá và tiến hành thanh toán an toàn. Miễn phí vận chuyển cho đơn hàng trên 500.000đ. Thanh toán COD, chuyển khoản, ví điện tử.";
    var totalPrice = Model?.Sum(x => (x.DiscountPrice ?? x.Price) * x.Quantity) ?? 0;
}

<div class="row">
    <div class="col-md-8">
        <h2 class="mb-4">Giỏ Hàng Của Bạn</h2>

        <!-- Cart Items Table -->
        <div class="card">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50%;">Sản Phẩm</th>
                            <th style="width: 15%;">Giá</th>
                            <th style="width: 15%;">Số Lượng</th>
                            <th style="width: 15%;">Tổng</th>
                            <th style="width: 5%;">Hành Động</th>
                        </tr>
                    </thead>
                    <tbody id="cart-items">
                        @if (Model != null && Model.Count > 0)
                        {
                            @foreach (var item in Model)
                            {
                                var price = item.DiscountPrice ?? item.Price;
                                var itemTotal = price * item.Quantity;
                                <tr class="cart-item" data-item-id="@item.CartItemId">
                                    <td>
                                        <div class="d-flex gap-3">
                                            <img src="@(string.IsNullOrEmpty(item.Product?.Image) ? "https://via.placeholder.com/80x80?text=" + System.Net.WebUtility.UrlEncode(item.Product?.ProductName ?? "Product") : item.Product?.Image)" 
                                                 alt="@(item.Product?.ProductName ?? "Sản phẩm") - Trong giỏ hàng"
                                                 style="width: 80px; height: 80px; object-fit: cover;"
                                                 loading="lazy"
                                                 decoding="async"
                                                 width="80"
                                                 height="80">
                                            <div>
                                                <h6 class="mb-1">@item.Product?.ProductName</h6>
                                                <small class="text-muted">SKU: @item.Product?.SKU</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="product-price">@price.ToString("N0")đ</span>
                                    </td>
                                    <td>
                                        <div class="input-group" style="width: 100px;">
                                            <button class="btn btn-outline-secondary btn-sm qty-decrease" type="button" data-item-id="@item.CartItemId" onclick="updateQtyDown(this)">-</button>
                                            <input type="number" class="form-control form-control-sm text-center quantity" value="@item.Quantity" min="1" data-item-id="@item.CartItemId">
                                            <button class="btn btn-outline-secondary btn-sm qty-increase" type="button" data-item-id="@item.CartItemId" onclick="updateQtyUp(this)">+</button>
                                        </div>
                                    </td>
                                    <td>
                                        <strong class="item-total">@itemTotal.ToString("N0")đ</strong>
                                    </td>
                                    <td>
                                        <button class="btn btn-danger btn-sm remove-item" type="button" data-item-id="@item.CartItemId" onclick="removeFromCartBtn(this)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            <!-- Empty Cart Message -->
            <div id="empty-cart-message" class="alert alert-info text-center py-4" style="display: none;">
                <i class="bi bi-cart-x" style="font-size: 3rem; color: #1b6ec2;"></i>
                <p class="mt-3 mb-0">Giỏ hàng của bạn đang trống</p>
                <a href="@Url.Action("List", "Product")" class="btn btn-primary mt-3">
                    <i class="bi bi-shop"></i> Tiếp Tục Mua Sắm
                </a>
            </div>
        </div>

        <!-- Cart Actions -->
        <div class="mt-3 d-flex justify-content-between">
            <a href="@Url.Action("List", "Product")" class="btn btn-outline-primary">
                <i class="bi bi-arrow-left"></i> Tiếp Tục Mua Sắm
            </a>
            <button class="btn btn-outline-danger" id="clear-cart-btn">
                <i class="bi bi-trash"></i> Xóa Tất Cả
            </button>
        </div>
    </div>

    <!-- Cart Summary -->
    <div class="col-md-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Tóm Tắt Đơn Hàng</h5>
            </div>
            <div class="card-body">
                <!-- Summary Details -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tổng sản phẩm:</span>
                        <strong><span id="total-items">@(Model?.Sum(x => x.Quantity) ?? 0)</span> sản phẩm</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tổng tiền hàng:</span>
                        <strong id="subtotal">@totalPrice.ToString("N0")đ</strong>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <span>Vận chuyển:</span>
                        <strong id="shipping-cost" class="text-success">Miễn phí</strong>
                    </div>

                    <hr>

                    <!-- Promo Code -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Mã Giảm Giá</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="promo-code" placeholder="Nhập mã giảm giá...">
                            <button class="btn btn-outline-secondary" type="button" id="apply-promo">Áp Dụng</button>
                        </div>
                    </div>

                    <!-- Discount -->
                    <div class="d-flex justify-content-between mb-3" id="discount-row" style="display: none;">
                        <span>Giảm giá:</span>
                        <strong class="text-danger">-<span id="discount-amount">0</span>đ</strong>
                    </div>

                    <hr>

                    <!-- Total -->
                    <div class="d-flex justify-content-between mb-4">
                        <span class="fw-bold">Tổng Cộng:</span>
                        <span class="h5 text-danger fw-bold" id="total-price">@totalPrice.ToString("N0")đ</span>
                    </div>
                </div>

                <!-- Checkout Button -->
                <a href="@Url.Action("Checkout", "Order")" class="btn btn-success btn-lg w-100 mb-2">
                    <i class="bi bi-credit-card"></i> Thanh Toán
                </a>

                <!-- Continue Shopping -->
                <a href="@Url.Action("List", "Product")" class="btn btn-outline-primary btn-lg w-100">
                    <i class="bi bi-shop"></i> Tiếp Tục Mua
                </a>
            </div>

            <!-- Cart Info -->
            <div class="card-footer bg-light">
                <small class="text-muted d-block mb-2">
                    <i class="bi bi-info-circle"></i> Vận chuyển miễn phí cho đơn từ 500.000đ
                </small>
                <small class="text-muted d-block">
                    <i class="bi bi-shield-check"></i> Thanh toán an toàn & bảo mật
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Shopping Benefits Section -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card bg-light">
            <div class="card-body">
                <h3 class="text-center mb-4">Mua Sắm An Toàn Tại KLDShop</h3>
                <div class="row">
                    <div class="col-md-3 text-center mb-3">
                        <i class="bi bi-shield-check text-success" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">Thanh Toán An Toàn</h5>
                        <p class="text-muted">Hỗ trợ nhiều phương thức thanh toán: COD, chuyển khoản, thẻ tín dụng, ví điện tử. 
                        Mọi giao dịch đều được mã hóa SSL/TLS bảo mật tuyệt đối.</p>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <i class="bi bi-truck text-primary" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">Giao Hàng Nhanh</h5>
                        <p class="text-muted">Miễn phí vận chuyển cho đơn hàng từ 500.000đ. Giao hàng nhanh trong 1-3 ngày 
                        tại nội thành các tỉnh thành lớn, 3-5 ngày tại các tỉnh khác.</p>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <i class="bi bi-arrow-repeat text-warning" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">Đổi Trả Dễ Dàng</h5>
                        <p class="text-muted">Chính sách đổi trả trong 30 ngày nếu sản phẩm có lỗi hoặc không đúng mô tả. 
                        Hoàn tiền 100% cho sản phẩm lỗi từ nhà sản xuất.</p>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <i class="bi bi-headset text-info" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">Hỗ Trợ 24/7</h5>
                        <p class="text-muted">Đội ngũ chăm sóc khách hàng chuyên nghiệp sẵn sàng tư vấn và hỗ trợ bạn 
                        qua hotline, email và chat trực tuyến mọi lúc mọi nơi.</p>
                    </div>
                </div>
                <div class="text-center mt-4">
                    <p class="mb-2"><strong>Câu hỏi thường gặp về thanh toán và vận chuyển:</strong></p>
                    <p class="text-muted mb-0">
                        KLDShop chấp nhận thanh toán khi nhận hàng (COD) trên toàn quốc. Bạn có thể kiểm tra sản phẩm trước khi thanh toán. 
                        Chúng tôi cũng hỗ trợ thanh toán online qua chuyển khoản ngân hàng, ví điện tử (Momo, ZaloPay, VNPay), 
                        và thẻ tín dụng/ghi nợ quốc tế. Mọi đơn hàng đều có mã theo dõi để bạn kiểm tra tình trạng vận chuyển.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Quantity decrease
        function updateQtyDown(btn) {
            let input = $(btn).siblings('.quantity');
            let qty = parseInt(input.val());
            if (qty > 1) {
                input.val(qty - 1);
                updateItemTotal($(btn).closest('tr'));
            }
        }

        // Quantity increase
        function updateQtyUp(btn) {
            let input = $(btn).siblings('.quantity');
            let qty = parseInt(input.val());
            input.val(qty + 1);
            updateItemTotal($(btn).closest('tr'));
        }

        // Remove item from cart
        function removeFromCartBtn(btn) {
            let itemId = $(btn).data('item-id');
            if (confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
                removeFromCart(itemId);
            }
        }

        $('.quantity').change(function () {
            updateItemTotal($(this).closest('tr'));
        });

        // Clear cart
        $('#clear-cart-btn').click(function () {
            if (confirm('Bạn có chắc muốn xóa tất cả sản phẩm?')) {
                $.ajax({
                    type: 'POST',
                    url: '/Cart/ClearCart',
                    success: function (response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert(response.message || 'Có lỗi xảy ra');
                        }
                    },
                    error: function () {
                        alert('Có lỗi khi xóa giỏ hàng');
                    }
                });
            }
        });

        // Update item total
        function updateItemTotal(row) {
            let price = parseInt(row.find('.product-price').text().replace(/[^\d]/g, ''));
            let qty = parseInt(row.find('.quantity').val());
            let total = price * qty;
            row.find('.item-total').text(total.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') + 'đ');
            updateCartTotal();
        }

        // Update cart total
        function updateCartTotal() {
            let subtotal = 0;
            let items = 0;

            $('.cart-item').each(function () {
                let total = parseInt($(this).find('.item-total').text().replace(/[^\d]/g, ''));
                subtotal += total;
                items += parseInt($(this).find('.quantity').val());
            });

            $('#total-items').text(items);
            $('#subtotal').text(subtotal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') + 'đ');
            $('#total-price').text(subtotal.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') + 'đ');

            // Show empty cart message if no items
            if (items === 0) {
                $('#empty-cart-message').show();
                $('.card').hide();
            }
        }

        // Apply promo code
        $('#apply-promo').click(function () {
            let code = $('#promo-code').val();
            if (code.trim() === '') {
                alert('Vui lòng nhập mã giảm giá');
                return;
            }
            alert('Áp dụng mã: ' + code);
            // TODO: Call API to validate and apply promo code
        });

        updateCartTotal();
    </script>
}
